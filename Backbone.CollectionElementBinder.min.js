(function(root){if(!root.Backbone){throw"Please include Backbone.js before Backbone.CollectionElementBinder.js"}if(!root.Backbone.ModelBinder){throw"Please include Backbone.ModelBinder.js before Backbone.CollectionElementBinder.js"}var Backbone=root.Backbone;var _=root._;var $=root.jQuery||root.Zepto||root.ender;if(!$){throw"Please include jQuery, Zepto, Ender before Backbone.CollectionElementBinder.js"}Backbone.CollectionElementBinder=function(){};Backbone.CollectionElementBinder.VERSION="0.1.0";_.extend(Backbone.CollectionElementBinder.prototype,Backbone.Events,{_collection:null,_listEl:null,_modelPrototypeEl:null,_modelBindings:null,_onlyResetBind:false,_modelBinders:null,_modelHtmlElements:null,bind:function(collection,listEl,prototypeEl,modelBindings,onlyResetBind){this.unbind();this._modelHtmlElements=[];this._modelBinders=[];this._collection=collection;this._listEl=$(listEl);this._modelPrototypeEl=$(prototypeEl);this._modelBindings=modelBindings;this._onlyResetBind=onlyResetBind;if(!this._collection)throw"Collection must be specified";if(_.isEmpty(this._listEl))throw"List HTML element must be specified";if(this._listEl.length>1)throw"Invalid list HTML element. Element count: "+this._listEl.length;if(_.isEmpty(this._modelPrototypeEl))throw"Model HTML prototype must be specified";if(this._modelPrototypeEl.length>1)throw"Invalid model HTML prototype. Element count: "+this._modelPrototypeEl.length;if(_.isEmpty(this._modelBindings))throw"Model bindings must be specified";$(this._modelPrototypeEl).hide();this._bindCollectionToView()},_bindCollectionToView:function(){this._collection.collectionBinder=this;this._collection.on("reset",this._onCollectionReset,this);if(!this._onlyResetBind){this._collection.on("add",this._onCollectionAdd,this);this._collection.on("remove",this._onCollectionRemove,this)}this._onCollectionReset()},unbind:function(){this._unbindCollectionToView();this._collection=null;this._listEl=null;this._modelBindings=null;this._onlyResetBind=false;this._modelBinders=null;this._modelHtmlElements=null},_unbindCollectionToView:function(){if(this._collection){this._collection.off("reset",this._onCollectionReset,this);this._collection.off("add",this._onCollectionAdd,this);this._collection.off("remove",this._onCollectionRemove,this);if(this._collection.collectionBinder){delete this._collection.collectionBinder}this._collection=null}this._hideModelHtmlElement(this._modelHtmlElements);$(this._modelHtmlElements).remove()},_onCollectionReset:function(){if(this._collection.length==0){this._unbindAllModels()}this._collection.each(function(model,i){this._bindModel(model,i)},this);var unbindStartIndex=this._collection.length;var bindersCount=this._modelBinders.length;for(var i=unbindStartIndex;i<bindersCount;i++){this._unbindModel(i,true)}this.trigger("reset",this._collection.models)},_onCollectionAdd:function(model,collection,options){this._bindModel(model,options.index);this.trigger("add",model)},_onCollectionRemove:function(model,collection,options){this._unbindModel(options.index);this.trigger("remove",model)},_bindModel:function(model,index){var htmlElement=this._getModelHtmlElement(index);this._getModelBinder(index).bind(model,htmlElement,this._modelBindings);this._showModelHtmlElement(htmlElement)},_unbindModel:function(index,dontMoveElement){this._getModelBinder(index).unbind();var htmlElement=this._getModelHtmlElement(index);this._hideModelHtmlElement(htmlElement);if(!dontMoveElement){$(htmlElement).detach().appendTo(this._listEl);this._recalcElementIndexes(index)}},_recalcElementIndexes:function(startIndex){startIndex=startIndex||0;this._modelHtmlElements=this._getAppendedModelHtmlElements();var newIndex=startIndex;_.each(this._modelHtmlElements,function(el,i){var currentIndex=parseInt($(el).attr("data-ceb-index"));if(currentIndex<startIndex){return}$(el).attr("data-ceb-index",newIndex);newIndex++})},_getAppendedModelHtmlElements:function(){return this._listEl.children().not(this._modelPrototypeEl).toArray()},_unbindAllModels:function(){_.each(this._modelBinders,function(binder,i){this._unbindModel(i)},this)},_getModelBinder:function(index){if(!this._modelBinders[index]){this._modelBinders[index]=new Backbone.ModelBinder}return this._modelBinders[index]},_getModelHtmlElement:function(index){if(!this._modelHtmlElements[index]){var appendedElements=this._getAppendedModelHtmlElements();var element=$(this._modelPrototypeEl).clone();element.attr("data-ceb-index",index);var previousIndexElement=$(appendedElements).filter("[data-ceb-index="+(index-1)+"]");if(previousIndexElement.length){previousIndexElement.after(element)}else{this._listEl.append(element)}this._modelHtmlElements[index]=element.get(0)}return this._modelHtmlElements[index]},_showModelHtmlElement:function(element){$(element).show()},_hideModelHtmlElement:function(element){$(element).hide()},_sortByIndex:function(elements){var sortedElements=elements.slice();_.each(elements,function(el,i){if($(sortedElements[i]).attr("data-ceb-index")<$(sortedElements[i-1]).attr("data-ceb-index")){var buffer=sortedElements[i];sortedElements[i]=sortedElements[i-1];sortedElements[i-1]=buffer}});return sortedElements},getModelHtmlElement:function(model){var index=this._collection.indexOf(model);if(index==-1){throw"Model is not in the collection"}return this._modelHtmlElements[index]}})})(this);